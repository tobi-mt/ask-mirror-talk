FROM python:3.11-slim

ENV PYTHONDONTWRITEBYTECODE=1
ENV PYTHONUNBUFFERED=1
ENV PIP_NO_CACHE_DIR=1
ENV PIP_DISABLE_PIP_VERSION_CHECK=1

WORKDIR /app

# Install runtime dependencies
RUN apt-get update \
    && apt-get install -y --no-install-recommends \
        ffmpeg \
        libpq5 \
        curl \
    && rm -rf /var/lib/apt/lists/*

COPY pyproject.toml README.md /app/

# Install core dependencies (NO ML PACKAGES - use OpenAI instead)
RUN pip install --no-cache-dir \
    fastapi==0.115.0 \
    uvicorn[standard]==0.30.0 \
    pydantic==2.7.0 \
    pydantic-settings==2.2.0 \
    sqlalchemy==2.0.36 \
    psycopg[binary]==3.1.19 \
    pgvector==0.2.5 \
    alembic==1.13.0 \
    httpx==0.27.0 \
    requests>=2.31.0 \
    feedparser==6.0.11 \
    apscheduler==3.10.4 \
    tenacity==8.3.0 \
    python-multipart==0.0.9 \
    python-dotenv==1.0.1 \
    openai>=1.0.0

# Install build tools temporarily for PyAV only
RUN apt-get update \
    && apt-get install -y --no-install-recommends \
        build-essential \
        libavcodec-dev \
        libavformat-dev \
        libavutil-dev \
        libswresample-dev \
        gcc \
        python3-dev \
    && pip install --no-cache-dir av>=12.0.0 \
    && apt-get purge -y --auto-remove \
        build-essential \
        libavcodec-dev \
        libavformat-dev \
        libavutil-dev \
        libswresample-dev \
        gcc \
        python3-dev \
    && rm -rf /var/lib/apt/lists/*

COPY app /app/app
COPY scripts /app/scripts

# Install the package to make imports work properly
RUN pip install --no-cache-dir --no-deps -e .

# Default CMD for scheduler (override in Railway for manual ingestion)
CMD ["python", "-m", "app.ingestion.scheduler"]
